<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style_kalkulator.css">
</head>

<body>
    <button class="theme-toggle" id="themeToggle">üåô</button>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-panel-header">
            <h3>Calculation History</h3>
            <button class="close-history-panel" id="closeHistoryPanel">√ó</button>
        </div>
        <div class="history-content" id="historyContent">
            <!-- History items will be added here dynamically -->
            <div class="history-empty">No calculations yet</div>
        </div>
        <div class="history-actions">
            <button class="history-clear-btn" id="clearHistory">Clear All</button>
            <button class="history-export-btn" id="exportHistory">Export</button>
        </div>
    </div>

    <!-- History Toggle Button -->
    <button class="history-toggle" id="historyToggle">
        <span>üìú History</span>
    </button>

    <div class="calculator-container">
        <!-- Function Panel (Side Panel) -->
        <div class="function-panel" id="functionPanel">
            <div class="function-panel-header">
                <h3>Functions</h3>
                <button class="close-panel" id="closeFunctionPanel">√ó</button>
            </div>

            <div class="function-categories">
                <!-- Trigonometric Functions -->
                <div class="function-category">
                    <div class="category-title">Trigonometry</div>
                    <div class="function-grid">
                        <button class="function-btn trig" data-func="sin(">sin</button>
                        <button class="function-btn trig" data-func="cos(">cos</button>
                        <button class="function-btn trig" data-func="tan(">tan</button>
                        <button class="function-btn trig" data-func="asin(">sin‚Åª¬π</button>
                        <button class="function-btn trig" data-func="acos(">cos‚Åª¬π</button>
                        <button class="function-btn trig" data-func="atan(">tan‚Åª¬π</button>
                    </div>
                </div>

                <!-- Constants -->
                <div class="function-category">
                    <div class="category-title">Constants</div>
                    <div class="function-grid">
                        <button class="function-btn const" data-action="pi">œÄ</button>
                        <button class="function-btn const" data-action="e">e</button>
                    </div>
                </div>

                <!-- Power Functions -->
                <div class="function-category">
                    <div class="category-title">Powers & Roots</div>
                    <div class="function-grid">
                        <button class="function-btn square" data-action="square">x¬≤</button>
                        <button class="function-btn square" data-action="cube">x¬≥</button>
                        <button class="function-btn square" data-action="sqrt">‚àöx</button>
                        <button class="function-btn square" data-action="cbrt">‚àõx</button>
                    </div>
                </div>

                <!-- Logarithmic Functions -->
                <div class="function-category">
                    <div class="category-title">Logarithms</div>
                    <div class="function-grid">
                        <button class="function-btn" data-func="log(">log‚ÇÅ‚ÇÄ</button>
                        <button class="function-btn" data-func="ln(">ln</button>
                    </div>
                </div>

                <!-- Other Functions -->
                <div class="function-category">
                    <div class="category-title">Other</div>
                    <div class="function-grid">
                        <button class="function-btn operator" data-func="Math.abs(">abs</button>
                        <button class="function-btn operator" data-func="Math.floor(">floor</button>
                        <button class="function-btn operator" data-func="Math.ceil(">ceil</button>
                        <button class="function-btn operator" data-func="Math.round(">round</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Calculator -->
        <div class="calculator">
            <input type="text" class="display" id="display" readonly>
            <div class="buttons">
                <!-- Clear buttons and first operator -->
                <button class="clear clear-c" id="clearBtn">C</button>
                <button class="clear backspace" id="backspaceBtn">‚å´</button>
                <button class="operator divide" data-operator="/">√∑</button>

                <!-- Numbers and operators -->
                <button class="number" data-number="7">7</button>
                <button class="number" data-number="8">8</button>
                <button class="number" data-number="9">9</button>
                <button class="operator multiply" data-operator="*">√ó</button>

                <button class="number" data-number="4">4</button>
                <button class="number" data-number="5">5</button>
                <button class="number" data-number="6">6</button>
                <button class="operator subtract" data-operator="-">-</button>

                <button class="number" data-number="1">1</button>
                <button class="number" data-number="2">2</button>
                <button class="number" data-number="3">3</button>
                <button class="operator add" data-operator="+">+</button>

                <button class="number zero" data-number="0">0</button>
                <button class="decimal" data-decimal=".">.</button>
                <button class="equals" id="equalsBtn">=</button>

                <!-- Basic functions -->
                <button class="operator" data-operator="(">(</button>
                <button class="operator" data-operator=")">)</button>
                <button class="square-btn" data-action="square">x¬≤</button>
                <button class="operator" data-operator="**">^</button>

                <!-- Function Toggle Button -->
                <button class="function-toggle" id="functionToggle">
                    <span>Show Functions</span>
                    <span class="arrow">‚ñº</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES =====
        let display = document.getElementById('display');
        let functionPanel = document.getElementById('functionPanel');
        let functionToggle = document.getElementById('functionToggle');
        let historyPanel = document.getElementById('historyPanel');
        let historyToggle = document.getElementById('historyToggle');
        let historyContent = document.getElementById('historyContent');
        let clearHistoryBtn = document.getElementById('clearHistory');
        let exportHistoryBtn = document.getElementById('exportHistory');
        let closeHistoryPanel = document.getElementById('closeHistoryPanel');
        let closeFunctionPanel = document.getElementById('closeFunctionPanel');

        let isFunctionPanelOpen = false;
        let isHistoryPanelOpen = false;
        let calculationHistory = JSON.parse(localStorage.getItem('calculatorHistory')) || [];

        // ===== THEME TOGGLE =====
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        function toggleTheme() {
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark);
        }

        // Load saved theme on page load
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'true') {
            body.classList.add('dark');
            themeToggle.textContent = '‚òÄÔ∏è';
        }

        // ===== HISTORY FUNCTIONS =====
        function addToHistory(expression, result) {
            const historyItem = {
                expression: expression,
                result: result,
                timestamp: new Date().toLocaleString()
            };

            calculationHistory.unshift(historyItem);
            if (calculationHistory.length > 20) {
                calculationHistory.pop();
            }

            localStorage.setItem('calculatorHistory', JSON.stringify(calculationHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            historyContent.innerHTML = '';

            if (calculationHistory.length === 0) {
                historyContent.innerHTML = '<div class="history-empty">üìä No calculations yet</div>';
                return;
            }

            calculationHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-content">
                        <div class="history-expression" title="${item.expression}">${item.expression}</div>
                        <div class="history-result">${item.result}</div>
                        <div class="history-timestamp">${item.timestamp}</div>
                    </div>
                    <button class="history-use-btn" data-index="${index}">Use</button>
                `;
                historyContent.appendChild(historyItem);
            });

            // Add event listeners to "Use" buttons
            document.querySelectorAll('.history-use-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    useHistoryItem(index);
                });
            });
        }

        function useHistoryItem(index) {
            if (calculationHistory[index]) {
                display.value = calculationHistory[index].result;
            }
            closeHistoryPanelFunc();
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                calculationHistory = [];
                localStorage.setItem('calculatorHistory', JSON.stringify(calculationHistory));
                updateHistoryDisplay();
            }
        }

        function exportHistory() {
            if (calculationHistory.length === 0) {
                alert('No history to export');
                return;
            }

            let exportText = 'Calculator History\n\n';
            calculationHistory.forEach((item, index) => {
                exportText += `${index + 1}. ${item.expression} = ${item.result}\n`;
                exportText += `   Time: ${item.timestamp}\n\n`;
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calculator_history.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== PANEL TOGGLE FUNCTIONS =====
        function toggleFunctionPanel() {
            isFunctionPanelOpen = !isFunctionPanelOpen;

            if (isFunctionPanelOpen) {
                functionPanel.style.display = 'block';
                functionToggle.innerHTML = '<span>Hide Functions</span><span class="arrow">‚ñº</span>';
                functionToggle.classList.add('active');

                // Close history panel if open
                if (isHistoryPanelOpen) {
                    closeHistoryPanelFunc();
                }
            } else {
                functionPanel.style.display = 'none';
                functionToggle.innerHTML = '<span>Show Functions</span><span class="arrow">‚ñº</span>';
                functionToggle.classList.remove('active');
            }
        }

        function toggleHistoryPanel() {
            isHistoryPanelOpen = !isHistoryPanelOpen;

            if (isHistoryPanelOpen) {
                historyPanel.style.display = 'block';
                historyToggle.classList.add('active');
                updateHistoryDisplay();

                // Close function panel if open
                if (isFunctionPanelOpen) {
                    closeFunctionPanelFunc();
                }
            } else {
                historyPanel.style.display = 'none';
                historyToggle.classList.remove('active');
            }
        }

        function closeHistoryPanelFunc() {
            historyPanel.style.display = 'none';
            historyToggle.classList.remove('active');
            isHistoryPanelOpen = false;
        }

        function closeFunctionPanelFunc() {
            functionPanel.style.display = 'none';
            functionToggle.innerHTML = '<span>Show Functions</span><span class="arrow">‚ñº</span>';
            functionToggle.classList.remove('active');
            isFunctionPanelOpen = false;
        }

        // ===== CALCULATOR FUNCTIONS =====
        function appendToDisplay(value) {
            // Convert operators for display
            if (value === '*') {
                value = '√ó';
            } else if (value === '/') {
                value = '√∑';
            }
            display.value += value;
        }

        function clearDisplay() {
            display.value = '';
        }

        function deleteLast() {
            display.value = display.value.slice(0, -1);
        }

        function insertFunction(func) {
            // Check if we need to add multiplication before function
            if (display.value !== '' && !/[+\-*/(^%]/.test(display.value.slice(-1))) {
                display.value += '*';
            }
            display.value += func;
        }

        function insertPi() {
            if (display.value === '' || /[+\-*/^(%]/.test(display.value.slice(-1))) {
                display.value += Math.PI;
            } else {
                display.value += '*' + Math.PI;
            }
        }

        function insertE() {
            if (display.value === '' || /[+\-*/^(%]/.test(display.value.slice(-1))) {
                display.value += Math.E;
            } else {
                display.value += '*' + Math.E;
            }
        }

        function calculateSquare() {
            if (display.value !== '') {
                try {
                    // Evaluate current expression and square it
                    let currentValue = eval(display.value);
                    const result = Math.pow(currentValue, 2);
                    addToHistory(`${display.value}¬≤`, result);
                    display.value = result;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(clearDisplay, 1500);
                }
            }
        }

        function calculateCube() {
            if (display.value !== '') {
                try {
                    let currentValue = eval(display.value);
                    const result = Math.pow(currentValue, 3);
                    addToHistory(`${display.value}¬≥`, result);
                    display.value = result;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(clearDisplay, 1500);
                }
            }
        }

        function insertSqrt() {
            if (display.value !== '') {
                try {
                    let currentValue = eval(display.value);
                    if (currentValue < 0) {
                        display.value = 'Error: Negative';
                        setTimeout(clearDisplay, 1500);
                        return;
                    }
                    const result = Math.sqrt(currentValue);
                    addToHistory(`‚àö(${display.value})`, result);
                    display.value = result;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(clearDisplay, 1500);
                }
            } else {
                display.value += 'Math.sqrt(';
            }
        }

        function insertCbrt() {
            if (display.value !== '') {
                try {
                    let currentValue = eval(display.value);
                    const result = Math.cbrt(currentValue);
                    addToHistory(`‚àõ(${display.value})`, result);
                    display.value = result;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(clearDisplay, 1500);
                }
            } else {
                display.value += 'Math.cbrt(';
            }
        }

        function calculate() {
            if (display.value === '') return;

            try {
                let originalExpression = display.value;
                let expression = display.value
                    .replace(/x/g, '*')
                    .replace(/√∑/g, '/')
                    .replace(/\^/g, '**')
                    .replace(/sin\(/g, 'Math.sin(Math.PI/180*')
                    .replace(/cos\(/g, 'Math.cos(Math.PI/180*')
                    .replace(/tan\(/g, 'Math.tan(Math.PI/180*')
                    .replace(/acos\(/g, '(Math.acos(')
                    .replace(/atan\(/g, '(Math.atan(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/Math\.abs\(/g, 'Math.abs(')
                    .replace(/Math\.floor\(/g, 'Math.floor(')
                    .replace(/Math\.ceil\(/g, 'Math.ceil(')
                    .replace(/Math\.round\(/g, 'Math.round(');

                // Close regular trig functions that expect degree input
                let depth = 0;
                let result_expr = '';
                for (let i = 0; i < expression.length; i++) {
                    const char = expression[i];
                    result_expr += char;
                    if (char === '(') depth++;
                    if (char === ')') depth--;

                    // Check if we're at the end and need to close trig functions
                    if (i === expression.length - 1 && depth > 0) {
                        for (let j = 0; j < depth; j++) {
                            result_expr += ')';
                        }
                    }
                }
                expression = result_expr;

                // Convert inverse trig results from radians to degrees
                expression = expression.replace(/\(Math\.(asin|acos|atan)\(([^)]+)\)\)/g, 'Math.max(Math.min($2, 1), -1) * 180/Math.PI');

                // Simpler approach: handle each trig function properly
                let finalExpr = display.value
                    .replace(/√ó/g, '*')
                    .replace(/√∑/g, '/')
                    .replace(/\^/g, '**');

                // Handle sin, cos, tan (convert degrees to radians)
                finalExpr = finalExpr.replace(/sin\(([^)]+)\)/g, 'Math.sin($1*Math.PI/180)');
                finalExpr = finalExpr.replace(/cos\(([^)]+)\)/g, 'Math.cos($1*Math.PI/180)');
                finalExpr = finalExpr.replace(/tan\(([^)]+)\)/g, 'Math.tan($1*Math.PI/180)');

                // Handle asin, acos, atan (convert result from radians to degrees)
                finalExpr = finalExpr.replace(/asin\(([^)]+)\)/g, 'Math.asin($1)*180/Math.PI');
                finalExpr = finalExpr.replace(/acos\(([^)]+)\)/g, 'Math.acos($1)*180/Math.PI');
                finalExpr = finalExpr.replace(/atan\(([^)]+)\)/g, 'Math.atan($1)*180/Math.PI');

                // Handle log and ln
                finalExpr = finalExpr.replace(/log\(([^)]+)\)/g, 'Math.log10($1)');
                finalExpr = finalExpr.replace(/ln\(([^)]+)\)/g, 'Math.log($1)');

                const result = eval(finalExpr);

                // Check for infinity (division by zero)
                if (!isFinite(result)) {
                    display.value = 'Not Defined';
                    addToHistory(originalExpression, 'Not Defined');
                } else {
                    display.value = result;
                    addToHistory(originalExpression, result);
                }

            } catch (error) {
                display.value = 'Error';
                setTimeout(clearDisplay, 1500);
            }
        }

        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);

            // Panel toggles
            functionToggle.addEventListener('click', toggleFunctionPanel);
            historyToggle.addEventListener('click', toggleHistoryPanel);
            closeFunctionPanel.addEventListener('click', closeFunctionPanelFunc);
            closeHistoryPanel.addEventListener('click', closeHistoryPanelFunc);

            // History buttons
            clearHistoryBtn.addEventListener('click', clearHistory);
            exportHistoryBtn.addEventListener('click', exportHistory);

            // Calculator buttons
            document.getElementById('clearBtn').addEventListener('click', clearDisplay);
            document.getElementById('backspaceBtn').addEventListener('click', deleteLast);
            document.getElementById('equalsBtn').addEventListener('click', calculate);

            // Number buttons
            document.querySelectorAll('.number').forEach(button => {
                button.addEventListener('click', () => {
                    appendToDisplay(button.getAttribute('data-number'));
                });
            });

            // Operator buttons
            document.querySelectorAll('[data-operator]').forEach(button => {
                button.addEventListener('click', () => {
                    appendToDisplay(button.getAttribute('data-operator'));
                });
            });

            // Decimal button
            document.querySelector('.decimal').addEventListener('click', () => {
                appendToDisplay('.');
            });

            // Function buttons
            document.querySelectorAll('[data-func]').forEach(button => {
                button.addEventListener('click', () => {
                    insertFunction(button.getAttribute('data-func'));
                });
            });

            // Action buttons
            document.querySelectorAll('[data-action]').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-action');
                    switch (action) {
                        case 'pi':
                            insertPi();
                            break;
                        case 'e':
                            insertE();
                            break;
                        case 'square':
                            calculateSquare();
                            break;
                        case 'cube':
                            calculateCube();
                            break;
                        case 'sqrt':
                            insertSqrt();
                            break;
                        case 'cbrt':
                            insertCbrt();
                            break;
                    }
                });
            });

            // Keyboard support
            document.addEventListener('keydown', function (event) {
                const key = event.key.toLowerCase();
                let targetButton = null;

                if (key >= '0' && key <= '9') {
                    targetButton = document.querySelector(`[data-number="${key}"]`);
                } else if (key === '.') {
                    targetButton = document.querySelector('.decimal');
                } else if (key === '+') {
                    targetButton = document.querySelector('.add');
                } else if (key === '-') {
                    targetButton = document.querySelector('.subtract');
                } else if (key === '*') {
                    targetButton = document.querySelector('.multiply');
                } else if (key === '/') {
                    event.preventDefault();
                    targetButton = document.querySelector('.divide');
                } else if (key === 'enter' || key === '=') {
                    event.preventDefault();
                    calculate();
                    return;
                } else if (key === 'escape' || key === 'c') {
                    targetButton = document.getElementById('clearBtn');
                    clearDisplay();
                } else if (key === 'backspace') {
                    targetButton = document.getElementById('backspaceBtn');
                    deleteLast();
                } else if (key === '(') {
                    targetButton = document.querySelector('[data-operator="("]');
                } else if (key === ')') {
                    targetButton = document.querySelector('[data-operator=")"]');
                } else if (key === 't') {
                    toggleTheme();
                    return;
                } else if (key === 'f') {
                    toggleFunctionPanel();
                    return;
                } else if (key === 'h') {
                    toggleHistoryPanel();
                    return;
                }

                if (targetButton) {
                    targetButton.click();
                    targetButton.classList.add('pressed');
                    setTimeout(() => targetButton.classList.remove('pressed'), 150);
                }
            });
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function () {
            setupEventListeners();
            updateHistoryDisplay();

            // Initialize panels as closed
            closeFunctionPanelFunc();
            closeHistoryPanelFunc();
        });
    </script>
</body>

</html>